<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backflow Reports</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
            background-color: #1e1e1e;
            color: #ffffff;
        }
        #headerContainer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #333333;
            position: relative;
        }
        #logoLeft, #logoRight {
            width: 50px;
            height: 50px;
            margin: 0 20px;
        }
        #title {
            text-align: center;
            font-size: 36px;
            font-weight: bold;
            color: #ffffff;
            margin: 0;
            flex-grow: 1;
        }
        #contactButton {
            padding: 10px 20px;
            font-size: 18px;
            color: #ffffff;
            background-color: #2a5d88;
            border: 1px solid #666666;
            border-radius: 8px;
            cursor: pointer;
        }
        #contactButton:hover {
            background-color: #3a7dbb;
        }
        #dateContainer {
            text-align: center;
            padding: 10px 0;
            background-color: #333333;
        }
        #dateInput {
            padding: 8px;
            font-size: 24px;
            background-color: #2a2a2a;
            color: #ffffff;
            border: 1px solid #666666;
            border-radius: 4px;
            width: 200px;
        }
        #spreadsheet {
            height: 700px;
            width: 100%;
            background-color: #2a2a2a;
            overflow: auto;
        }
        #buttonContainer {
            text-align: center;
            padding: 20px;
            background-color: #2a2a2a;
            border-top: 2px solid #444444;
        }
        button {
            padding: 20px 40px;
            font-size: 24px;
            color: #ffffff;
            border: 1px solid #666666;
            border-radius: 8px;
            cursor: pointer;
            margin: 0 10px;
        }
        #exportButton {
            background-color: #444444;
        }
        #exportButton:hover {
            background-color: #555555;
        }
        #printButton {
            background-color: #2a5d88;
            padding: 20px 40px; /* Matches other buttons */
        }
        #printButton:hover {
            background-color: #3a7dbb;
        }
        #deleteButton {
            background-color: #662222;
        }
        #deleteButton:hover {
            background-color: #883333;
        }
        #confirmationPopup, #contactPopup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333333;
            padding: 20px;
            border: 2px solid #666666;
            border-radius: 8px;
            z-index: 1000;
            text-align: center;
        }
        #confirmationPopup button, #contactPopup button {
            padding: 10px 20px;
            font-size: 18px;
            margin: 10px;
        }
        #confirmationPopup #confirmYes {
            background-color: #662222;
        }
        #confirmationPopup #confirmYes:hover {
            background-color: #883333;
        }
        #confirmationPopup #confirmNo {
            background-color: #444444;
        }
        #confirmationPopup #confirmNo:hover {
            background-color: #555555;
        }
        #contactPopup #callButton {
            background-color: #2a5d88;
        }
        #contactPopup #callButton:hover {
            background-color: #3a7dbb;
        }
        #contactPopup #textButton {
            background-color: #444444;
        }
        #contactPopup #textButton:hover {
            background-color: #555555;
        }
        .handsontable {
            color: #ffffff;
            background-color: #2a2a2a;
        }
        .handsontable th {
            background-color: #333333;
            color: #ffffff;
        }
        .handsontable td {
            background-color: #2a2a2a;
            color: #ffffff;
            border-color: #444444;
        }
        .handsontable .ht__highlight {
            background-color: #3a3a3a;
        }
        @media print {
            body {
                background-color: white;
                color: black;
            }
            #headerContainer {
                background-color: white;
                border-bottom: 2px solid black;
            }
            #logoLeft, #logoRight {
                width: 60px;
                height: 60px;
            }
            #title {
                color: black;
                font-size: 28px;
            }
            #dateContainer {
                background-color: white;
                padding: 5px 0;
            }
            #dateInput {
                border: none;
                background-color: white;
                color: black;
                font-size: 18px;
            }
            #spreadsheet, #printTable {
                background-color: white;
                height: auto;
            }
            #printTable {
                width: 100%;
                border-collapse: collapse;
            }
            #printTable th, #printTable td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: left;
            }
            #printTable th {
                background-color: #f0f0f0;
                color: black;
            }
            #printTable td {
                background-color: white;
                color: black;
            }
            #spreadsheet, #buttonContainer, #confirmationPopup, #contactPopup {
                display: none;
            }
            @page {
                size: auto;
                margin: 15mm;
            }
        }
    </style>
</head>
<body>
    <div id="headerContainer">
        <img id="logoLeft" src="./logo-left.png" alt="Left Logo">
        <div id="title">Backflow Reports</div>
        <img id="logoRight" src="./logo-right.png" alt="Right Logo">
        <button id="contactButton">Contact Office</button>
    </div>
    <div id="dateContainer">
        <input type="date" id="dateInput" value="">
    </div>
    <div id="spreadsheet"></div>
    <div id="buttonContainer">
        <button id="exportButton">Save/Send</button>
        <button id="printButton">Print</button>
        <button id="deleteButton">Delete Data</button>
    </div>
    <div id="confirmationPopup">
        <p>Are you sure you want to delete all data?</p>
        <button id="confirmYes">Yes</button>
        <button id="confirmNo">No</button>
    </div>
    <div id="contactPopup">
        <p>Contact Office: (509)-679-3264</p>
        <button id="callButton">Call</button>
        <button id="textButton">Text</button>
    </div>
    <script>
        window.addEventListener('DOMContent fail', () => {
            const container = document.getElementById('spreadsheet');
            const dateInput = document.getElementById('dateInput');

            // Custom Numeric Editor for iOS
            class CustomNumericEditor extends Handsontable.editors.NumericEditor {
                prepare(row, col, prop, td, value, cellProperties) {
                    super.prepare(row, col, prop, td, value, cellProperties);
                    const input = this.TEXTAREA;
                    input.setAttribute('inputmode', 'decimal');
                    input.setAttribute('pattern', '[0-9]*');
                    input.setAttribute('type', 'number');
                    input.style.background = '#2a2a2a';
                    input.style.color = '#ffffff';
                    input.style.border = 'none';
                }
            }

            // Custom Text Editor for iOS
            class CustomTextEditor extends Handsontable.editors.TextEditor {
                prepare(row, col, prop, td, value, cellProperties) {
                    super.prepare(row, col, prop, td, value, cellProperties);
                    const input = this.TEXTAREA;
                    input.setAttribute('inputmode', 'text');
                    input.setAttribute('type', 'text');
                    input.style.background = '#2a2a2a';
                    input.style.color = '#ffffff';
                    input.style.border = 'none';
                }
            }

            // Register the custom editors
            Handsontable.editors.registerEditor('customNumeric', CustomNumericEditor);
            Handsontable.editors.registerEditor('customText', CustomTextEditor);

            // Initialize Handsontable
            const hot = new Handsontable(container, {
                data: Array(20).fill().map(() => Array(5).fill('')),
                rowHeaders: true,
                colHeaders: ['PSI', 'CV #1', 'CV #2', 'RV Opening', 'Notes'],
                colWidths: [100, 100, 100, 100, 200],
                rowHeights: 40,
                minRows: 20,
                maxRows: 20,
                minCols: 5,
                contextMenu: true,
                licenseKey: 'non-commercial-and-evaluation',
                stretchH: 'all',
                cells: function(row, col, prop) {
                    if (col < 4) { // PSI, CV #1, CV #2, RV Opening
                        return {
                            type: 'numeric',
                            editor: 'customNumeric'
                        };
                    } else { // Notes
                        return {
                            type: 'text',
                            editor: 'customText'
                        };
                    }
                },
                afterScrollVertically: function() {
                    this.render();
                }
            });

            // Load data from localStorage
            function loadFromLocalStorage() {
                const savedData = localStorage.getItem(' mennbackflowReports');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    let spreadsheetData = parsedData.spreadsheet || [];
                    if (spreadsheetData.length > 20) spreadsheetData = spreadsheetData.slice(0, 20);
                    else if (spreadsheetData.length < 20) spreadsheetData = spreadsheetData.concat(Array(20 - spreadsheetData.length).fill().map(() => Array(5).fill('')));
                    hot.loadData(spreadsheetData);
                    dateInput.value = parsedData.date || '';
                }
                hot.render();
                console.log('Rows loaded:', hot.countRows());
            }

            // Save data to localStorage
            function saveToLocalStorage() {
                const data = {
                    spreadsheet: hot.getData(),
                    date: dateInput.value
                };
                localStorage.setItem('backflowReports', JSON.stringify(data));
            }

            // Load initial data
            loadFromLocalStorage();

            // Save on every change
            hot.addHook('afterChange', saveToLocalStorage);
            dateInput.addEventListener('change', saveToLocalStorage);

            // Export to CSV with custom filename
            document.getElementById('exportButton').addEventListener('click', () => {
                const defaultName = 'Backflow_Reports_' + (dateInput.value || 'NoDate');
                const customName = prompt('Enter file name for CSV export:', defaultName);
 Taxonomy               if (customName) {
                    const exportPlugin = hot.getPlugin('exportFile');
                    exportPlugin.downloadFile('csv', { filename: customName });
                }
            });

            // Print functionality
            document.getElementById('printButton').addEventListener('click', () => {
                const printTable = document.createElement('table');
                printTable.id = 'printTable';
                const thead = document.createElement('thead');
                const tbody = document.createElement('tbody');
                const headers = ['PSI', 'CV #1', 'CV #2', 'RV Opening', 'Notes'];

                const headerRow = document.createElement('tr');
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);

                const data = hot.getData();
                data.forEach(rowData => {
                    const tr = document.createElement('tr');
                    rowData.forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell || '';
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });

                printTable.appendChild(thead);
                printTable.appendChild(tbody);
                document.body.appendChild(printTable);

                const originalTitle = document.getElementById('title').textContent;
                const dateValue = dateInput.value || 'No Date';
                document.getElementById('title').textContent = `Backflow Reports - ${dateValue}`;

                window.print();

                document.getElementById('title').textContent = originalTitle;
                document.body.removeChild(printTable);
            });

            // Delete data with confirmation
            const deleteButton = document.getElementById('deleteButton');
            const confirmationPopup = document.getElementById('confirmationPopup');
            const confirmYes = document.getElementById('confirmYes');
            const confirmNo = document.getElementById('confirmNo');

            deleteButton.addEventListener('click', () => {
                confirmationPopup.style.display = 'block';
            });

            confirmYes.addEventListener('click', () => {
                const emptyData = {
                    spreadsheet: Array(20).fill().map(() => Array(5).fill('')),
                    date: ''
                };
                hot.loadData(emptyData.spreadsheet);
                dateInput.value = '';
                localStorage.setItem('backflowReports', JSON.stringify(emptyData));
                confirmationPopup.style.display = 'none';
                hot.render();
            });

            confirmNo.addEventListener('click', () => {
                confirmationPopup.style.display = 'none';
            });

            // Contact Office functionality
            const contactButton = document.getElementById('contactButton');
            const contactPopup = document.getElementById('contactPopup');
            const callButton = document.getElementById('callButton');
            const textButton = document.getElementById('textButton');

            contactButton.addEventListener('click', () => {
                contactPopup.style.display = 'block';
            });

            callButton.addEventListener('click', () => {
                window.location.href = 'tel:+15096793264';
                contactPopup.style.display = 'none';
            });

            textButton.addEventListener('click', () => {
                window.location.href = 'sms:+15096793264';
                contactPopup.style.display = 'none';
            });

            // Close contact popup when clicking outside
            document.addEventListener('click', (event) => {
                if (!contactPopup.contains(event.target) && event.target !== contactButton) {
                    contactPopup.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
