<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backflow Reports</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
            background-color: #1e1e1e;
            color: #ffffff;
        }
        #headerContainer {
            background-color: #333333;
            padding: 10px 20px;
            position: relative;
        }
        #logoTitleContainer {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #logoLeft, #logoRight {
            width: 100px;
            height: 100px;
            margin: 0 20px;
        }
        #title {
            text-align: center;
            font-size: 36px;
            font-weight: bold;
            color: #ffffff;
            margin: 0;
            flex-grow: 0;
        }
        #dateContactContainer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
        }
        #dateContainer {
            flex-grow: 0;
        }
        #dateInput {
            padding: 8px;
            font-size: 24px;
            background-color: #2a2a2a;
            color: #ffffff;
            border: 1px solid #666666;
            border-radius: 4px;
            width: 200px;
        }
        #contactButton {
            padding: 10px 20px;
            font-size: 18px;
            color: #ffffff;
            background-color: #2a5d88;
            border: 1px solid #666666;
            border-radius: 8px;
            cursor: pointer;
        }
        #contactButton:hover {
            background-color: #3a7dbb;
        }
        #spreadsheet {
            height: 700px;
            width: 100%;
            background-color: #2a2a2a;
            overflow: auto;
        }
        #buttonContainer {
            text-align: center;
            padding: 20px;
            background-color: #2a2a2a;
            border-top: 2px solid #444444;
        }
        button {
            padding: 20px 40px;
            font-size: 24px;
            color: #ffffff;
            border: 1px solid #666666;
            border-radius: 8px;
            cursor: pointer;
            margin: 0 10px;
        }
        #exportButton {
            background-color: #444444;
        }
        #exportButton:hover {
            background-color: #555555;
        }
        #printButton {
            background-color: #2a5d88;
            padding: 20px 40px;
        }
        #printButton:hover {
            background-color: #3a7dbb;
        }
        #deleteButton {
            background-color: #662222;
        }
        #deleteButton:hover {
            background-color: #883333;
        }
        #confirmationPopup, #contactPopup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333333;
            padding: 20px;
            border: 2px solid #666666;
            border-radius: 8px;
            z-index: 1000;
            text-align: center;
        }
        #confirmationPopup button, #contactPopup button {
            padding: 10px 20px;
            font-size: 18px;
            margin: 10px;
        }
        #confirmationPopup #confirmYes {
            background-color: #662222;
        }
        #confirmationPopup #confirmYes:hover {
            background-color: #883333;
        }
        #confirmationPopup #confirmNo {
            background-color: #444444;
        }
        #confirmationPopup #confirmNo:hover {
            background-color: #555555;
        }
        #contactPopup #callButton {
            background-color: #2a5d88;
        }
        #contactPopup #callButton:hover {
            background-color: #3a7dbb;
        }
        #contactPopup #textButton {
            background-color: #444444;
        }
        #contactPopup #textButton:hover {
            background-color: #555555;
        }
        #contactPopup #cancelButton {
            background-color: #666666;
        }
        #contactPopup #cancelButton:hover {
            background-color: #888888;
        }
        .handsontable {
            color: #ffffff;
            background-color: #2a2a2a;
        }
        .handsontable th {
            background-color: #333333;
            color: #ffffff;
        }
        .handsontable td {
            background-color: #2a2a2a;
            color: #ffffff;
            border-color: #444444;
        }
        .handsontable .ht__highlight {
            background-color: #3a3a3a;
        }
        .handsontable .ht__active_highlight {
            background-color: #333333;
            color: #000000 !important;
            font-weight: bold !important;
        }
        .handsontable th.ht__highlight {
            background-color: #333333;
            color: #000000 !important;
            font-weight: bold !important;
        }
        .handsontable .ht__active_highlight.ht__highlight,
        .handsontable th.ht__active_highlight.ht__highlight {
            color: #000000 !important;
        }
        .handsontable .htCore .htEditor_active .htEditor_input {
            color: #000000 !important;
            background-color: #ffffff !important;
        }
        /* Ensure text is black in highlighted rows */
        .handsontable td[style*="rgba(255, 0, 0, 0.2)"], 
        .handsontable td[style*="rgba(0, 255, 0, 0.2)"] {
            color: #000000 !important;
        }
        @media print {
            body {
                background-color: white;
                color: black;
            }
            #headerContainer {
                background-color: white;
                border-bottom: 2px solid black;
            }
            #logoTitleContainer {
                display: flex;
                justify-content: center;
                align-items: center;
            }
            #logoLeft, #logoRight {
                width: 120px;
                height: 120px;
            }
            #title {
                color: black;
                font-size: 28px;
            }
            #dateContactContainer {
                display: flex;
                justify-content: space-between;
                margin-top: 5px;
            }
            #dateContainer {
                flex-grow: 0;
            }
            #dateInput {
                border: none;
                background-color: white;
                color: black;
                font-size: 18px;
            }
            #contactButton {
                display: none;
            }
            #spreadsheet, #printTable {
                background-color: white;
                height: auto;
            }
            #printTable {
                width: 100%;
                border-collapse: collapse;
            }
            #printTable th, #printTable td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: left;
            }
            #printTable th {
                background-color: #f0f0f0;
                color: black;
            }
            #printTable td {
                background-color: white;
                color: black;
            }
            #spreadsheet, #buttonContainer, #confirmationPopup, #contactPopup {
                display: none;
            }
            @page {
                size: auto;
                margin: 15mm;
            }
        }
    </style>
</head>
<body>
    <div id="headerContainer">
        <div id="logoTitleContainer">
            <img id="logoLeft" src="./logo-left.png" alt="Left Logo">
            <div id="title">Backflow Reports</div>
            <img id="logoRight" src="./logo-right.png" alt="Right Logo">
        </div>
        <div id="dateContactContainer">
            <div id="dateContainer">
                <input type="date" id="dateInput" value="">
            </div>
            <button id="contactButton">Contact Office</button>
        </div>
    </div>
    <div id="spreadsheet"></div>
    <div id="buttonContainer">
        <button id="exportButton">Save/Send</button>
        <button id="printButton">Print</button>
        <button id="deleteButton">Delete Data</button>
    </div>
    <div id="confirmationPopup">
        <p>Are you sure you want to delete all data?</p>
        <button id="confirmYes">Yes</button>
        <button id="confirmNo">No</button>
    </div>
    <div id="contactPopup">
        <p>Contact Office: (509)-679-3264</p>
        <button id="callButton">Call</button>
        <button id="textButton">Text</button>
        <button id="cancelButton">Cancel</button>
    </div>
    <script>
        console.log('Script started');
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded');

            const container = document.getElementById('spreadsheet');
            const dateInput = document.getElementById('dateInput');
            console.log('Container:', container, 'DateInput:', dateInput);

            // Custom Numeric Editor with auto-decimal for PSID columns
            class CustomNumericEditor extends Handsontable.editors.NumericEditor {
                prepare(row, col, prop, td, value, cellProperties) {
                    super.prepare(row, col, prop, td, value, cellProperties);
                    const input = this.TEXTAREA;
                    input.setAttribute('inputmode', 'decimal');
                    input.setAttribute('pattern', '[0-9]*');
                    input.setAttribute('type', 'number');
                    input.style.background = '#ffffff';
                    input.style.color = '#000000';
                    input.style.border = 'none';
                }
                setValue(value) {
                    if (value !== null && value !== '' && (this.col === 1 || this.col === 2 || this.col === 3)) { // CV #1, CV #2, RV Opening
                        let numStr = value.toString().replace('.', ''); // Remove existing decimal
                        if (numStr.length > 1) {
                            numStr = numStr.slice(0, -1) + '.' + numStr.slice(-1); // Insert decimal before last digit
                        }
                        this.TEXTAREA.value = numStr;
                    } else {
                        this.TEXTAREA.value = value || '';
                    }
                }
            }

            // Custom Text Editor for iOS
            class CustomTextEditor extends Handsontable.editors.TextEditor {
                prepare(row, col, prop, td, value, cellProperties) {
                    super.prepare(row, col, prop, td, value, cellProperties);
                    const input = this.TEXTAREA;
                    input.setAttribute('inputmode', 'text');
                    input.setAttribute('type', 'text');
                    input.style.background = '#ffffff';
                    input.style.color = '#000000';
                    input.style.border = 'none';
                }
            }

            // Register the custom editors
            Handsontable.editors.registerEditor('customNumeric', CustomNumericEditor);
            Handsontable.editors.registerEditor('customText', CustomTextEditor);

            // Initialize Handsontable
            const hot = new Handsontable(container, {
                data: Array(20).fill().map(() => Array(5).fill('')),
                rowHeaders: true,
                colHeaders: ['PSI (PSI)', 'CV #1 (PSID)', 'CV #2 (PSID)', 'RV Opening (PSID)', 'Notes'],
                colWidths: [120, 120, 120, 120, 200],
                rowHeights: 40,
                minRows: 20,
                maxRows: 20,
                minCols: 5,
                contextMenu: true,
                licenseKey: 'non-commercial-and-evaluation',
                stretchH: 'all',
                cells: function(row, col, prop) {
                    if (col < 4) {
                        return { type: 'numeric', editor: 'customNumeric' };
                    } else {
                        return { type: 'text', editor: 'customText' };
                    }
                },
                beforeRenderer: function(TD, row, col, prop, value, cellProperties) {
                    try {
                        const data = hot.getData();
                        const psi = data[row][0];
                        const cv1 = data[row][1] === '' || data[row][1] === null ? NaN : parseFloat(data[row][1]);
                        const cv2 = data[row][2] === '' || data[row][2] === null ? NaN : parseFloat(data[row][2]);
                        const rv = data[row][3];

                        const isFilled = psi !== '' && psi !== null && !isNaN(parseFloat(psi)) &&
                                        !isNaN(cv1) && !isNaN(cv2);
                        const hasAnyValue = (psi !== '' && psi !== null) || !isNaN(cv1) || !isNaN(cv2) || (rv !== '' && rv !== null);
                        const cvBelowThreshold = (!isNaN(cv1) && cv1 < 1.0) || (!isNaN(cv2) && cv2 < 1.0);
                        const isValid = isFilled && cv1 >= 1.0 && cv2 >= 1.0;

                        TD.style.backgroundColor = '#2a2a2a';
                        if (isValid) {
                            TD.style.backgroundColor = 'rgba(0, 255, 0, 0.2)';
                        } else if (hasAnyValue || (isFilled && cvBelowThreshold)) {
                            TD.style.backgroundColor = 'rgba(255, 0, 0, 0.2)';
                        }

                        if (row === 0 && col === 0) {
                            console.log(`Row ${row}: PSI=${psi}, CV1=${cv1}, CV2=${cv2}, RV=${rv}, isFilled=${isFilled}, hasAnyValue=${hasAnyValue}, cvBelowThreshold=${cvBelowThreshold}, isValid=${isValid}`);
                        }
                    } catch (error) {
                        console.error('Error in beforeRenderer:', error);
                        TD.style.backgroundColor = '#2a2a2a'; // Fallback
                    }
                },
                afterScrollVertically: function() {
                    this.render();
                }
            });
            console.log('Handsontable initialized');

            // Load data from localStorage
            function loadFromLocalStorage() {
                const savedData = localStorage.getItem('backflowReports');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    let spreadsheetData = parsedData.spreadsheet || [];
                    if (spreadsheetData.length > 20) spreadsheetData = spreadsheetData.slice(0, 20);
                    else if (spreadsheetData.length < 20) spreadsheetData = spreadsheetData.concat(Array(20 - spreadsheetData.length).fill().map(() => Array(5).fill('')));
                    hot.loadData(spreadsheetData);
                    dateInput.value = parsedData.date || '';
                }
                hot.render();
                console.log('Data loaded, rows:', hot.countRows());
            }

            // Save data to localStorage
            function saveToLocalStorage() {
                const data = {
                    spreadsheet: hot.getData(),
                    date: dateInput.value
                };
                localStorage.setItem('backflowReports', JSON.stringify(data));
                console.log('Data saved');
            }

            // Load initial data
            loadFromLocalStorage();

            // Save on every change
            hot.addHook('afterChange', saveToLocalStorage);
            dateInput.addEventListener('change', saveToLocalStorage);

            // Export to CSV with custom filename
            document.getElementById('exportButton').addEventListener('click', () => {
                console.log('Export button clicked');
                const defaultName = 'Backflow_Reports_' + (dateInput.value || 'NoDate');
                const customName = prompt('Enter file name for CSV export:', defaultName);
                if (customName) {
                    const exportPlugin = hot.getPlugin('exportFile');
                    exportPlugin.downloadFile('csv', { filename: customName });
                }
            });

            // Print functionality
            document.getElementById('printButton').addEventListener('click', () => {
                console.log('Print button clicked');
                const printTable = document.createElement('table');
                printTable.id = 'printTable';
                const thead = document.createElement('thead');
                const tbody = document.createElement('tbody');
                const headers = ['PSI (PSI)', 'CV #1 (PSID)', 'CV #2 (PSID)', 'RV Opening (PSID)', 'Notes'];

                const headerRow = document.createElement('tr');
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);

                const data = hot.getData();
                data.forEach(rowData => {
                    const tr = document.createElement('tr');
                    rowData.forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell || '';
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });

                printTable.appendChild(thead);
                printTable.appendChild(tbody);
                document.body.appendChild(printTable);

                const originalTitle = document.getElementById('title').textContent;
                const dateValue = dateInput.value || 'No Date';
                document.getElementById('title').textContent = `Backflow Reports - ${dateValue}`;

                window.print();

                document.getElementById('title').textContent = originalTitle;
                document.body.removeChild(printTable);
            });

            // Delete data with confirmation
            const deleteButton = document.getElementById('deleteButton');
            const confirmationPopup = document.getElementById('confirmationPopup');
            const confirmYes = document.getElementById('confirmYes');
            const confirmNo = document.getElementById('confirmNo');

            deleteButton.addEventListener('click', () => {
                console.log('Delete button clicked');
                confirmationPopup.style.display = 'block';
            });

            confirmYes.addEventListener('click', () => {
                console.log('Confirm Yes clicked');
                const emptyData = {
                    spreadsheet: Array(20).fill().map(() => Array(5).fill('')),
                    date: ''
                };
                hot.loadData(emptyData.spreadsheet);
                dateInput.value = '';
                localStorage.setItem('backflowReports', JSON.stringify(emptyData));
                confirmationPopup.style.display = 'none';
                hot.render();
            });

            confirmNo.addEventListener('click', () => {
                console.log('Confirm No clicked');
                confirmationPopup.style.display = 'none';
            });

            // Contact Office functionality
            const contactButton = document.getElementById('contactButton');
            const contactPopup = document.getElementById('contactPopup');
            const callButton = document.getElementById('callButton');
            const textButton = document.getElementById('textButton');
            const cancelButton = document.getElementById('cancelButton');

            contactButton.addEventListener('click', () => {
                console.log('Contact button clicked');
                contactPopup.style.display = 'block';
            });

            callButton.addEventListener('click', () => {
                console.log('Call button clicked');
                window.location.href = 'tel:+15096793264';
                contactPopup.style.display = 'none';
            });

            textButton.addEventListener('click', () => {
                console.log('Text button clicked');
                window.location.href = 'sms:+15096793264';
                contactPopup.style.display = 'none';
            });

            cancelButton.addEventListener('click', () => {
                console.log('Cancel button clicked');
                contactPopup.style.display = 'none';
            });

            document.addEventListener('click', (event) => {
                if (!contactPopup.contains(event.target) && event.target !== contactButton) {
                    contactPopup.style.display = 'none';
                }
            });

            console.log('All event listeners attached');
        });
    </script>
</body>
</html>
